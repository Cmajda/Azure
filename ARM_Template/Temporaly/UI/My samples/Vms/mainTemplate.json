{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "ApplicationName": {
            "type": "string",
            "minLength": 4,
            "maxLength": 8,
            "metadata": { "Description": "Give it some reasonable application name. Try to be between 4 - 8 characters in length. This is important especially for Windows VMs as the name has 15 characters limit." },
            "defaultValue": "ARMTemp"
        },
        "CountrySITSIO": {
            "type": "string",
            "allowedValues": [
                "Afghanistan",
                "Albania",
                "Algeria",
                "American Samoa",
                "Andorra",
                "Angola",
                "Anguilla",
                "Antarctica",
                "Antigua and Barbuda",
                "Argentina",
                "Armenia",
                "Aruba",
                "Australia",
                "Austria",
                "Azerbaijan",
                "Bahamas",
                "Bahrain",
                "Bangladesh",
                "Barbados",
                "Belarus",
                "Belgium",
                "Belize",
                "Benin",
                "Bermuda",
                "Bhutan",
                "Bolivia",
                "Bonaire",
                "Bosnia and Herzegovina",
                "Botswana",
                "Bouvet Island",
                "Brazil",
                "British Indian Ocean Territory",
                "Brunei Darussalam",
                "Bulgaria",
                "Burkina Faso",
                "Burundi",
                "Cambodia",
                "Cameroon",
                "Canada",
                "Cape Verde",
                "Cayman Islands",
                "Central African Republic",
                "Chad",
                "Chile",
                "China",
                "Christmas Island",
                "Cocos (Keeling) Islands",
                "Colombia",
                "Comoros",
                "Congo",
                "Democratic Republic of the Congo",
                "Cook Islands",
                "Costa Rica",
                "Croatia",
                "Cuba",
                "Curacao",
                "Cyprus",
                "Czech Republic",
                "Cote d'Ivoire",
                "Denmark",
                "Djibouti",
                "Dominica",
                "Dominican Republic",
                "Ecuador",
                "Egypt",
                "El Salvador",
                "Equatorial Guinea",
                "Eritrea",
                "Estonia",
                "Ethiopia",
                "Falkland Islands (Malvinas)",
                "Faroe Islands",
                "Fiji",
                "Finland",
                "France",
                "French Guiana",
                "French Polynesia",
                "French Southern Territories",
                "Gabon",
                "Gambia",
                "Georgia",
                "Germany",
                "Ghana",
                "Gibraltar",
                "Greece",
                "Greenland",
                "Grenada",
                "Guadeloupe",
                "Guam",
                "Guatemala",
                "Guernsey",
                "Guinea",
                "Guinea-Bissau",
                "Guyana",
                "Haiti",
                "Heard Island and McDonald Islands",
                "Holy See (Vatican City State)",
                "Honduras",
                "Hong Kong",
                "Hungary",
                "Iceland",
                "India",
                "Indonesia",
                "Iran, Islamic Republic of",
                "Iraq",
                "Ireland",
                "Isle of Man",
                "Israel",
                "Italy",
                "Jamaica",
                "Japan",
                "Jersey",
                "Jordan",
                "Kazakhstan",
                "Kenya",
                "Kiribati",
                "Korea, Democratic People's Republic of",
                "Korea, Republic of",
                "Kuwait",
                "Kyrgyzstan",
                "Lao People's Democratic Republic",
                "Latvia",
                "Lebanon",
                "Lesotho",
                "Liberia",
                "Libya",
                "Liechtenstein",
                "Lithuania",
                "Luxembourg",
                "Macao",
                "Macedonia, the Former Yugoslav Republic of",
                "Madagascar",
                "Malawi",
                "Malaysia",
                "Maldives",
                "Mali",
                "Malta",
                "Marshall Islands",
                "Martinique",
                "Mauritania",
                "Mauritius",
                "Mayotte",
                "Mexico",
                "Micronesia, Federated States of",
                "Moldova, Republic of",
                "Monaco",
                "Mongolia",
                "Montenegro",
                "Montserrat",
                "Morocco",
                "Mozambique",
                "MSF IO",
                "Myanmar",
                "Namibia",
                "Nauru",
                "Nepal",
                "Netherlands",
                "New Caledonia",
                "New Zealand",
                "Nicaragua",
                "Niger",
                "Nigeria",
                "Niue",
                "Norfolk Island",
                "Northern Mariana Islands",
                "Norway",
                "Oman",
                "Pakistan",
                "Palau",
                "Palestine, State of",
                "Panama",
                "Papua New Guinea",
                "Paraguay",
                "Peru",
                "Philippines",
                "Pitcairn",
                "Poland",
                "Portugal",
                "Puerto Rico",
                "Qatar",
                "Romania",
                "Russian Federation",
                "Rwanda",
                "Reunion",
                "Saint Barthelemy",
                "Saint Helena",
                "Saint Kitts and Nevis",
                "Saint Lucia",
                "Saint Martin (French part)",
                "Saint Pierre and Miquelon",
                "Saint Vincent and the Grenadines",
                "Samoa",
                "San Marino",
                "Sao Tome and Principe",
                "Saudi Arabia",
                "Senegal",
                "Serbia",
                "Seychelles",
                "Sierra Leone",
                "Singapore",
                "Sint Maarten (Dutch part)",
                "SITS",
                "Slovakia",
                "Slovenia",
                "Solomon Islands",
                "Somalia",
                "South Africa",
                "South Georgia and the South Sandwich Islands",
                "South Sudan",
                "Spain",
                "Sri Lanka",
                "Sudan",
                "Suriname",
                "Svalbard and Jan Mayen",
                "Swaziland",
                "Sweden",
                "Switzerland",
                "Syrian Arab Republic",
                "Taiwan",
                "Tajikistan",
                "United Republic of Tanzania",
                "Thailand",
                "Timor-Leste",
                "Togo",
                "Tokelau",
                "Tonga",
                "Trinidad and Tobago",
                "Tunisia",
                "Turkey",
                "Turkmenistan",
                "Turks and Caicos Islands",
                "Tuvalu",
                "Uganda",
                "Ukraine",
                "United Arab Emirates",
                "United Kingdom",
                "United States",
                "United States Minor Outlying Islands",
                "Uruguay",
                "Uzbekistan",
                "Vanuatu",
                "Venezuela",
                "Viet Nam",
                "British Virgin Islands",
                "US Virgin Islands",
                "Wallis and Futuna",
                "Western Sahara",
                "Yemen",
                "Zambia",
                "Zimbabwe"
            ]
        },
        "IndexSuffix": {
            "type": "string",
            "maxLength": 3,
            "metadata": { "Description": "For cases where more instances of the same app will be necessary, for testing and other scenarios" },
            "defaultValue": "01"

        },
        "Tagdescription": {
            "type": "string",
            "minLength": 21,
            "maxLength": 512,
            "metadata": { "Description": "Short description of resource group. For example \"In order to test the new site.\"" },
            "defaultValue": "Testování v rámci arm template pro vytvoření VMs"
        },
        "TagStage": {
            "type": "string",
            "metadata": { "description": "Select a value of the \"tag Stage\"" },
            "allowedValues": [ "Live", "Test", "Dev", "Sandbox" ],
            "defaultValue": "Live"
        },
        "TagCustomer": {
            "type": "string",
            "minLength": 3,
            "maxLength": 512,
            "metadata": { "Description": "Name of customer for example \"MFS\"" },
            "defaultValue": "MFS"
        },
        "TagAdministrator": {
            "type": "string",
            "minLength": 3,
            "maxLength": 512,
            "metadata": { "Description": "Name of administrator for example \"Jan Koudela\"" },
            "defaultValue": "Cmajda"
        },
        "TagDeployment": {
            "type": "string",
            "metadata": { "description": "Select a value of the \"Tag Deployment\"" },
            "defaultValue": "Arm",
            "allowedValues": [ "Manual", "Arm", "Tf", "Ps", "Cli" ]
        },
        "virtualNetworkName": {
            "type": "string",
            "metadata": {
                "description": "vnet"
            }
        },
        "virtualNetworkResourceGroup": {
            "type": "string",
            "metadata": {
                "description": "Resource group of the VNet"
            },
            "defaultValue": "network-rg"
        },
        "subnetName": {
            "type": "String",
            "defaultValue": "default"
        },
        "publicIpAddressType": {
            "type": "String",
            "defaultValue": "Dynamic"
        },
        "publicIpAddressSku": {
            "type": "String",
            "defaultValue": "Basic"
        },
        "osDiskType": {
            "type": "String",
            "defaultValue": "Standard_LRS"
        },
        "DataDiskType_1": {
            "type": "String",
            "defaultValue": "Standard_LRS"
        },
        "DataDiskType_2": {
            "type": "String",
            "defaultValue": "Standard_LRS"
        },
        "DataDiskSize_1": {
            "type": "int",
            "defaultValue": 32
        },
        "DataDiskSize_2": {
            "type": "int",
            "defaultValue": 32
        },
        "virtualMachineSize": {
            "type": "String",
            "defaultValue": "Standard_B1ls"
        },
        "adminUsername": {
            "type": "String",
            "defaultValue": "admin123"
        },
        "vaultSubscription": {
            "type": "String",
            "defaultValue": "[subscription().subscriptionId]"
        },
        "vaultResourceGroupName": {
            "type": "String"
        },
        "vaultName": {
            "type": "String"
        },
        "imageReference": {
            "type": "string",
            "metadata": {
                "description": "description"
            }
        },
        "CountDatadisk": {
            "type": "int",
            "metadata": {
                "description": "description"
            }
        }

    },
    "variables": {
        "FullTag": {
            "Application": "[parameters('ApplicationName')]",
            "Country": "[parameters('CountrySITSIO')]",
            "Customer": "[parameters('TagCustomer')]",
            "Administrator": "[parameters('TagAdministrator')]",
            "Deployment": "[parameters('TagDeployment')]",
            "Description": "[parameters('Tagdescription')]",
            "Stage": "[parameters('TagStage')]"
        },
        "networkInterfaceName": "[concat('nic-',variables('CountryObject').value[parameters('CountrySITSIO')], '-', parameters('ApplicationName'),'-',parameters('IndexSuffix'))]",
        "networkSecurityGroupName": "[concat('nsg-',variables('CountryObject').value[parameters('CountrySITSIO')], '-', parameters('ApplicationName'),'-',parameters('IndexSuffix'))]",
        "publicIpAddressName": "[concat('pip-',variables('CountryObject').value[parameters('CountrySITSIO')], '-', parameters('ApplicationName'),'-',parameters('IndexSuffix'))]",
        "virtualMachineName": "[concat('vm',variables('CountryObject').value[parameters('CountrySITSIO')],parameters('ApplicationName'),parameters('IndexSuffix'))]",
        "nsgId": "[resourceId(resourceGroup().name, 'Microsoft.Network/networkSecurityGroups', variables('networkSecurityGroupName'))]",
        "vnetId": "[resourceId(parameters('virtualNetworkResourceGroup'),'Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]",
        "subnetRef": "[concat(variables('vnetId'), '/subnets/', parameters('subnetName'))]",
        "datadiskName_1": "[concat('dsk-',variables('CountryObject').value[parameters('CountrySITSIO')], '-', parameters('ApplicationName'),'-',parameters('IndexSuffix'),'-01')]",
        "datadiskName_2": "[concat('dsk-',variables('CountryObject').value[parameters('CountrySITSIO')], '-', parameters('ApplicationName'),'-',parameters('IndexSuffix'),'-02')]",
        "datadiskNameOS": "[concat('dsk-',variables('CountryObject').value[parameters('CountrySITSIO')], '-', parameters('ApplicationName'),'-',parameters('IndexSuffix'),'-OS')]",
        "CountryObject": {
            "type": "object",
            "value": {
                "Afghanistan": "af",
                "Albania": "al",
                "Algeria": "dz",
                "American Samoa": "as",
                "Andorra": "ad",
                "Angola": "ao",
                "Anguilla": "ai",
                "Antarctica": "aq",
                "Antigua and Barbuda": "ag",
                "Argentina": "ar",
                "Armenia": "am",
                "Aruba": "aw",
                "Australia": "au",
                "Austria": "at",
                "Azerbaijan": "az",
                "Bahamas": "bs",
                "Bahrain": "bh",
                "Bangladesh": "bd",
                "Barbados": "bb",
                "Belarus": "by",
                "Belgium": "be",
                "Belize": "bz",
                "Benin": "bj",
                "Bermuda": "bm",
                "Bhutan": "bt",
                "Bolivia": "bo",
                "Bonaire": "bq",
                "Bosnia and Herzegovina": "ba",
                "Botswana": "bw",
                "Bouvet Island": "bv",
                "Brazil": "br",
                "British Indian Ocean Territory": "io",
                "Brunei Darussalam": "bn",
                "Bulgaria": "bg",
                "Burkina Faso": "bf",
                "Burundi": "bi",
                "Cambodia": "kh",
                "Cameroon": "cm",
                "Canada": "ca",
                "Cape Verde": "cv",
                "Cayman Islands": "ky",
                "Central African Republic": "cf",
                "Chad": "td",
                "Chile": "cl",
                "China": "cn",
                "Christmas Island": "cx",
                "Cocos (Keeling) Islands": "cc",
                "Colombia": "co",
                "Comoros": "km",
                "Congo": "cg",
                "Democratic Republic of the Congo": "cd",
                "Cook Islands": "ck",
                "Costa Rica": "cr",
                "Croatia": "hr",
                "Cuba": "cu",
                "Curacao": "cw",
                "Cyprus": "cy",
                "Czech Republic": "cz",
                "Cote d'Ivoire": "ci",
                "Denmark": "dk",
                "Djibouti": "dj",
                "Dominica": "dm",
                "Dominican Republic": "do",
                "Ecuador": "ec",
                "Egypt": "eg",
                "El Salvador": "sv",
                "Equatorial Guinea": "gq",
                "Eritrea": "er",
                "Estonia": "ee",
                "Ethiopia": "et",
                "Falkland Islands (Malvinas)": "fk",
                "Faroe Islands": "fo",
                "Fiji": "fj",
                "Finland": "fi",
                "France": "fr",
                "French Guiana": "gf",
                "French Polynesia": "pf",
                "French Southern Territories": "tf",
                "Gabon": "ga",
                "Gambia": "gm",
                "Georgia": "ge",
                "Germany": "de",
                "Ghana": "gh",
                "Gibraltar": "gi",
                "Greece": "gr",
                "Greenland": "gl",
                "Grenada": "gd",
                "Guadeloupe": "gp",
                "Guam": "gu",
                "Guatemala": "gt",
                "Guernsey": "gg",
                "Guinea": "gn",
                "Guinea-Bissau": "gw",
                "Guyana": "gy",
                "Haiti": "ht",
                "Heard Island and McDonald Islands": "hm",
                "Holy See (Vatican City State)": "va",
                "Honduras": "hn",
                "Hong Kong": "hk",
                "Hungary": "hu",
                "Iceland": "is",
                "India": "in",
                "Indonesia": "id",
                "Iran, Islamic Republic of": "ir",
                "Iraq": "iq",
                "Ireland": "ie",
                "Isle of Man": "im",
                "Israel": "il",
                "Italy": "it",
                "Jamaica": "jm",
                "Japan": "jp",
                "Jersey": "je",
                "Jordan": "jo",
                "Kazakhstan": "kz",
                "Kenya": "ke",
                "Kiribati": "ki",
                "Korea, Democratic People's Republic of": "kp",
                "Korea, Republic of": "kr",
                "Kuwait": "kw",
                "Kyrgyzstan": "kg",
                "Lao People's Democratic Republic": "la",
                "Latvia": "lv",
                "Lebanon": "lb",
                "Lesotho": "ls",
                "Liberia": "lr",
                "Libya": "ly",
                "Liechtenstein": "li",
                "Lithuania": "lt",
                "Luxembourg": "lu",
                "Macao": "mo",
                "Macedonia, the Former Yugoslav Republic of": "mk",
                "Madagascar": "mg",
                "Malawi": "mw",
                "Malaysia": "my",
                "Maldives": "mv",
                "Mali": "ml",
                "Malta": "mt",
                "Marshall Islands": "mh",
                "Martinique": "mq",
                "Mauritania": "mr",
                "Mauritius": "mu",
                "Mayotte": "yt",
                "Mexico": "mx",
                "Micronesia, Federated States of": "fm",
                "Moldova, Republic of": "md",
                "Monaco": "mc",
                "Mongolia": "mn",
                "Montenegro": "me",
                "Montserrat": "ms",
                "Morocco": "ma",
                "Mozambique": "mz",
                "MSF IO": "mi",
                "Myanmar": "mm",
                "Namibia": "na",
                "Nauru": "nr",
                "Nepal": "np",
                "Netherlands": "nl",
                "New Caledonia": "nc",
                "New Zealand": "nz",
                "Nicaragua": "ni",
                "Niger": "ne",
                "Nigeria": "ng",
                "Niue": "nu",
                "Norfolk Island": "nf",
                "Northern Mariana Islands": "mp",
                "Norway": "no",
                "Oman": "om",
                "Pakistan": "pk",
                "Palau": "pw",
                "Palestine, State of": "ps",
                "Panama": "pa",
                "Papua New Guinea": "pg",
                "Paraguay": "py",
                "Peru": "pe",
                "Philippines": "ph",
                "Pitcairn": "pn",
                "Poland": "pl",
                "Portugal": "pt",
                "Puerto Rico": "pr",
                "Qatar": "qa",
                "Romania": "ro",
                "Russian Federation": "ru",
                "Rwanda": "rw",
                "Reunion": "re",
                "Saint Barthelemy": "bl",
                "Saint Helena": "sh",
                "Saint Kitts and Nevis": "kn",
                "Saint Lucia": "lc",
                "Saint Martin (French part)": "mf",
                "Saint Pierre and Miquelon": "pm",
                "Saint Vincent and the Grenadines": "vc",
                "Samoa": "ws",
                "San Marino": "sm",
                "Sao Tome and Principe": "st",
                "Saudi Arabia": "sa",
                "Senegal": "sn",
                "Serbia": "rs",
                "Seychelles": "sc",
                "Sierra Leone": "sl",
                "Singapore": "sg",
                "Sint Maarten (Dutch part)": "sx",
                "SITS": "ts",
                "Slovakia": "sk",
                "Slovenia": "si",
                "Solomon Islands": "sb",
                "Somalia": "so",
                "South Africa": "za",
                "South Georgia and the South Sandwich Islands": "gs",
                "South Sudan": "ss",
                "Spain": "es",
                "Sri Lanka": "lk",
                "Sudan": "sd",
                "Suriname": "sr",
                "Svalbard and Jan Mayen": "sj",
                "Swaziland": "sz",
                "Sweden": "se",
                "Switzerland": "ch",
                "Syrian Arab Republic": "sy",
                "Taiwan": "tw",
                "Tajikistan": "tj",
                "United Republic of Tanzania": "tz",
                "Thailand": "th",
                "Timor-Leste": "tl",
                "Togo": "tg",
                "Tokelau": "tk",
                "Tonga": "to",
                "Trinidad and Tobago": "tt",
                "Tunisia": "tn",
                "Turkey": "tr",
                "Turkmenistan": "tm",
                "Turks and Caicos Islands": "tc",
                "Tuvalu": "tv",
                "Uganda": "ug",
                "Ukraine": "ua",
                "United Arab Emirates": "ae",
                "United Kingdom": "gb",
                "United States": "us",
                "United States Minor Outlying Islands": "um",
                "Uruguay": "uy",
                "Uzbekistan": "uz",
                "Vanuatu": "vu",
                "Venezuela": "ve",
                "Viet Nam": "vn",
                "British Virgin Islands": "vg",
                "US Virgin Islands": "vi",
                "Wallis and Futuna": "wf",
                "Western Sahara": "eh",
                "Yemen": "ye",
                "Zambia": "zm",
                "Zimbabwe": "zw"

            }
        },
        "dataDisks": {
            "type": "Array",
            "Value": [
                {
                    "lun": 1,
                    "createOption": "attach",
                    "caching": "None",
                    "writeAcceleratorEnabled": false,
                    "id": null,
                    "name": "[variables('datadiskName_1')]",
                    "storageAccountType": null,
                    "diskSizeGB": null,
                    "diskEncryptionSet": null
                },
                {
                    "lun": 2,
                    "createOption": "attach",
                    "caching": "None",
                    "writeAcceleratorEnabled": false,
                    "id": null,
                    "name": "[variables('datadiskName_2')]",
                    "storageAccountType": null,
                    "diskSizeGB": null,
                    "diskEncryptionSet": null
                }
            ]
        },
        "dataDiskResources": {
            "type": "Array",
            "Value": [
                {
                    "name": "[variables('datadiskName_1')]",
                    "sku": "[parameters('DataDiskType_1')]",
                    "properties": {
                        "diskSizeGB": "[parameters('DataDiskSize_1')]",
                        "creationData": {
                            "createOption": "empty"
                        }
                    }
                },
                {
                    "name": "[variables('datadiskName_2')]",
                    "sku": "[parameters('DataDiskType_2')]",
                    "properties": {
                        "diskSizeGB": "[parameters('DataDiskSize_2')]",
                        "creationData": {
                            "createOption": "empty"
                        }
                    }
                }
            ]
        },
        "ListOfImages": {
            "value": {
                "Image01": {
                    "publisher": "MicrosoftWindowsServer",
                    "offer": "WindowsServer",
                    "sku": "2016-Datacenter",
                    "version": "latest"
                },
                "Image02": {
                    "publisher": "MicrosoftWindowsDesktop",
                    "offer": "Windows-10",
                    "sku": "20h1-ent-g2",
                    "version": "latest"
                }
            }
        }
    },
    "resources": [
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2018-05-01",
            "name": "VirtulaMachineKeyVault",
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "adminUsername": {
                            "type": "string"
                        },
                        "adminPassword": {
                            "type": "securestring"
                        },
                        "location": {
                            "type": "string"
                        },
                        "virtualMachineName": {
                            "type": "string"
                        },
                        "networkInterfaceName": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "virtualMachineSize": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "datadiskNameOS": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "osDiskType": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "dataDisks": {
                            "type": "Object",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "FullTag": {
                            "type": "Object",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "dataDiskResources": {
                            "type": "Object",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "networkSecurityGroupName": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "publicIpAddressName": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "publicIpAddressType": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "publicIpAddressSku": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "virtualNetworkName": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "subnetRef": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "nsgId": {
                            "type": "string",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "ListOfImages": {
                            "type": "Object",
                            "metadata": {
                                "description": "description"
                            }
                        },
                        "CountDatadisk": {
                            "type": "int",
                            "metadata": {
                                "description": "description"
                            }
                        }

                    },
                    "resources": [
                        {
                            "name": "[parameters('networkSecurityGroupName')]",
                            "type": "Microsoft.Network/networkSecurityGroups",
                            "apiVersion": "2019-02-01",
                            "location": "[resourceGroup().location]",
                            "properties": {},
                            "tags": "[parameters('FullTag')]"
                        },
                        {
                            "name": "[parameters('publicIpAddressName')]",
                            "type": "Microsoft.Network/publicIpAddresses",
                            "apiVersion": "2019-02-01",
                            "location": "[resourceGroup().location]",
                            "properties": {
                                "publicIpAllocationMethod": "[parameters('publicIpAddressType')]"
                            },
                            "sku": {
                                "name": "[parameters('publicIpAddressSku')]"
                            },
                            "tags": "[parameters('FullTag')]"
                        },
                        {
                            "name": "[parameters('networkInterfaceName')]",
                            "type": "Microsoft.Network/networkInterfaces",
                            "apiVersion": "2018-10-01",
                            "location": "[resourceGroup().location]",
                            "dependsOn": [
                                "[concat('Microsoft.Network/virtualNetworks/', parameters('virtualNetworkName'))]",
                                "[concat('Microsoft.Network/publicIpAddresses/', parameters('publicIpAddressName'))]",
                                "[concat('Microsoft.Network/networkSecurityGroups/', parameters('networkSecurityGroupName'))]"


                            ],
                            "properties": {
                                "ipConfigurations": [
                                    {
                                        "name": "ipconfig1",
                                        "properties": {
                                            "subnet": {
                                                "id": "[parameters('subnetRef')]"
                                            },
                                            "privateIPAllocationMethod": "Dynamic",
                                            "publicIpAddress": {
                                                "id": "[resourceId('Microsoft.Network/publicIpAddresses', parameters('publicIpAddressName'))]"

                                            }
                                        }
                                    }
                                ],
                                "networkSecurityGroup": {
                                    "id": "[parameters('nsgId')]"
                                }
                            },
                            "tags": "[parameters('FullTag')]"
                        },
                        {
                            "condition": "[greater(parameters('CountDatadisk'),0)]",
                            "name": "[parameters('dataDiskResources').Value[copyIndex()].name]",
                            "type": "Microsoft.Compute/disks",
                            "apiVersion": "2020-05-01",
                            "location": "[resourceGroup().location]",
                            "properties": "[parameters('dataDiskResources').Value[copyIndex()].properties]",
                            "sku": {
                                "name": "[parameters('dataDiskResources').Value[copyIndex()].sku]"
                            },
                            "copy": {
                                "name": "managedDiskResources",
                                "count": "[parameters('CountDatadisk')]"
                            },
                            "tags": "[parameters('FullTag')]"
                        },
                        {

                            "name": "[parameters('virtualMachineName')]",
                            "type": "Microsoft.Compute/virtualMachines",
                            "apiVersion": "2020-06-01",
                            "location": "[parameters('location')]",
                            "dependsOn": [
                                "managedDiskResources",
                                "[concat('Microsoft.Network/networkInterfaces/', parameters('networkInterfaceName'))]"
                            ],
                            "properties": {
                                "hardwareProfile": {
                                    "vmSize": "[parameters('virtualMachineSize')]"
                                },
                                "storageProfile": {
                                    "osDisk": {
                                        "name": "[parameters('datadiskNameOS')]",
                                        "createOption": "fromImage",
                                        "managedDisk": {
                                            "storageAccountType": "[parameters('osDiskType')]"
                                        }
                                    },
                                    "imageReference": "[parameters('ListOfImages')]",
                                    "copy": [
                                        {
                                            "name": "dataDisks",
                                            "count": "[parameters('CountDatadisk')]",
                                            "input": {
                                                "lun": "[parameters('dataDisks').Value[copyIndex('dataDisks')].lun]",
                                                "createOption": "[parameters('dataDisks').Value[copyIndex('dataDisks')].createOption]",
                                                "caching": "[parameters('dataDisks').Value[copyIndex('dataDisks')].caching]",
                                                "diskSizeGB": "[parameters('dataDisks').Value[copyIndex('dataDisks')].diskSizeGB]",
                                                "managedDisk": {
                                                    "id": "[coalesce(parameters('dataDisks').Value[copyIndex('dataDisks')].id, if(equals(parameters('dataDisks').Value[copyIndex('dataDisks')].name, json('null')), json('null'), resourceId('Microsoft.Compute/disks', parameters('dataDisks').Value[copyIndex('dataDisks')].name)))]",
                                                    "storageAccountType": "[parameters('dataDisks').Value[copyIndex('dataDisks')].storageAccountType]"
                                                },
                                                "writeAcceleratorEnabled": "[parameters('dataDisks').Value[copyIndex('dataDisks')].writeAcceleratorEnabled]"
                                            }
                                        }
                                    ]
                                },
                                "networkProfile": {
                                    "networkInterfaces": [
                                        {
                                            "id": "[resourceId('Microsoft.Network/networkInterfaces', parameters('networkInterfaceName'))]"
                                        }
                                    ]
                                },
                                "osProfile": {
                                    "computerName": "[parameters('virtualMachineName')]",
                                    "adminUsername": "[parameters('adminUsername')]",
                                    "adminPassword": "[parameters('adminPassword')]"
                                },
                                "diagnosticsProfile": {
                                    "bootDiagnostics": {
                                        "enabled": true
                                    }
                                }
                            },
                            "tags": "[parameters('FullTag')]"
                        },
                        {

                            "condition": "[equals(parameters('virtualNetworkName'),'new')]",
                            "name": "[parameters('virtualNetworkName')]",
                            "type": "Microsoft.Network/virtualNetworks",
                            "apiVersion": "2019-09-01",
                            "location": "[resourceGroup().location]",
                            "properties": {
                                "addressSpace": {
                                    "addressPrefixes": [ "NotSet" ]
                                },
                                "subnets": [ { "name": "NOTSET" } ]
                            },
                            "tags": "[parameters('FullTag')]"
                        }
                    ],
                    "outputs": {}
                },
                "parameters": {
                    "location": {
                        "value": "[resourceGroup().location]"
                    },
                    "adminUsername": {
                        "value": "[parameters('adminUsername')]"
                    },
                    "adminPassword": {
                        "reference": {
                            "keyVault": {
                                "id": "[resourceId(parameters('vaultSubscription'), parameters('vaultResourceGroupName'), 'Microsoft.KeyVault/vaults', parameters('vaultName'))]"
                            },
                            "secretName": "AdminKey"
                        }
                    },
                    "virtualMachineName": {
                        "value": "[variables('virtualMachineName')]"
                    },
                    "networkInterfaceName": {
                        "value": "[variables('networkInterfaceName')]"
                    },
                    "virtualMachineSize": {
                        "value": "[parameters('virtualMachineSize')]"
                    },
                    "datadiskNameOS": {
                        "value": "[variables('datadiskNameOS')]"
                    },
                    "dataDisks": {
                        "value": "[variables('dataDisks')]"
                    },
                    "FullTag": {
                        "value": "[variables('FullTag')]"
                    },
                    "osDiskType": {
                        "value": "[parameters('osDiskType')]"
                    },
                    "dataDiskResources": {
                        "value": "[variables('dataDiskResources')]"
                    },
                    "networkSecurityGroupName": {
                        "value": "[variables('networkSecurityGroupName')]"
                    },
                    "nsgId": {
                        "value": "[variables('nsgId')]"
                    },
                    "publicIpAddressName": {
                        "value": "[variables('publicIpAddressName')]"
                    },
                    "publicIpAddressSku": {
                        "value": "[parameters('publicIpAddressSku')]"
                    },
                    "publicIpAddressType": {
                        "value": "[parameters('publicIpAddressType')]"
                    },
                    "subnetRef": {
                        "value": "[variables('subnetRef')]"
                    },
                    "virtualNetworkName": {
                        "value": "[parameters('virtualNetworkName')]"
                    },
                    "ListOfImages": {
                        "value": "[variables('ListOfImages').value[parameters('imageReference')]]"
                    },
                    "CountDatadisk": {
                        "value": "[parameters('CountDatadisk')]"
                    }
                }
            }
        }

    ],
    "outputs": {
        "adminUsername": {
            "type": "string",
            "value": "[parameters('adminUsername')]"
        }

    }
}
